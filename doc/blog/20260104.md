# January 4, 2026 - Architecture Refinement & Context Design

## Summary

Today focused on cleaning up architectural concerns and establishing the foundation for document context/tagging system.

## Git Commits (Chronological)

- `02e5a76` - Added description to extracted entities; Factored-out AgentRespondJson class for correct LLMResult->Json
- `377a522` - Loading of promt for jsonSchema instructions from file
- `be5213a` - Added blog post with roadmap
- `00bd0dd` - Storage of claims in a file
- `d45b64e` - Extracted AiCore
- `c278e6b` - Added the ContextHierarchy.md to doc
- `162826e` - Clean-up of Document usages

## What We Accomplished

### 1. Internal API Cleanup
- **Moved IAiCore and AgentRespondJson** from `Knowledge.Contract` to `Knowledge` component (made internal)
- These were only used between Agent and AiCore internally, not part of public contract
- Cleaner separation between public contracts and internal implementation details

### 2. Document Architecture Simplification
- **Removed IDocument interface** - unnecessary abstraction
- **Made Document a public DTO** in `Knowledge.Contract`
- Document properties: `Id`, `Content`, `Tags` (IReadOnlyList<string>)
- Clean ownership: Knowledge owns domain concept, Storage is pure persistence layer
- **Removed StorageDocument class** - was adding unused metadata (CreatedAt, Version)

### 3. Storage API Refactoring
- Changed `IStorage.StoreDocument(string content, IEnumerable<string> tags)` 
- To: `IStorage.StoreDocument(Document document)`
- Storage now accepts domain objects instead of primitives
- NotesController can create Document instances and pass to Storage
- Storage adds ID if not provided, serializes directly

### 4. Context Hierarchy Design
- **Created ContextHierarchy.md** documenting three-level model:
  - **Domain** (most abstract): "Engineering", "Product", "Operations"
  - **Context** (middle): "KnowU Project", "Authentication Feature"
  - **Tags** (granular): ["security", "OAuth", "API"]
- Tags currently simple strings (`List<string>`)
- **Tag Thesaurus** planned for Phase 2 after real usage data collected
- Decision: Tag documents only (not individual claims) - claims inherit context from source document

### 5. Test Quality Improvements
- Refactored AgentTest to use readonly mock fields initialized in SetUp
- Updated all tests to use Document directly (no mocks needed for simple DTO)
- All 21 unit tests passing
- Integration test uses concrete Document instances

## Architecture State

**Clean Dependency Flow:**
```
WebApi → Knowledge.Contract (Document, Claim, IAgent)
       → Storage.Contract (IStorage)
Storage.Contract → Knowledge.Contract (Document, Claim)
Knowledge → Knowledge.Contract + Storage.Contract
```

**No circular dependencies ✅**

**Document Creation Flow:**
1. NotesController creates `new Document { Content = "...", Tags = [...] }`
2. Calls `storage.StoreDocument(document)`
3. Storage generates ID if needed, serializes to file
4. Worker thread pulls documents from storage
5. Agent.ProcessAsync(document) extracts claims

## Next Steps

### Immediate (Ready to Implement)
1. **NotesController endpoint** to accept document creation requests
2. **Background worker** to poll storage for unprocessed documents
3. **Agent processing integration** - connect the full pipeline

### Phase 2 (After Usage Data)
1. Collect real tagging patterns from actual document creation
2. Build **TagRegistry** for:
   - Canonical tag normalization ("auth" → "authentication")
   - Synonym mapping
   - Related tags discovery
   - Tag categorization
3. Implement context-aware queries
4. Cross-context knowledge discovery

### Future Considerations
- Domain/Context vocabulary management (controlled vs free-form)
- Multi-context document handling
- Persona-domain access control
- LLM-assisted tag suggestion (validation only, not auto-tagging)

## Key Decisions Made

1. ✅ **Tags on documents only** - simpler, ontology handles claim semantics
2. ✅ **Document is public DTO** - no factory pattern needed, straightforward instantiation
3. ✅ **Storage is infrastructure** - pure persistence, no domain logic
4. ✅ **Start with simple tags** - build thesaurus from real data, not speculation
5. ✅ **User-defined context** - explicit tagging at document creation, not LLM-inferred

## Files Changed/Created
- `Knowledge.Contract/Document.cs` - Public DTO (was IDocument interface)
- `Knowledge/IAiCore.cs` - Moved from Contract (now internal)
- `Knowledge/AgentRespondJson.cs` - Moved from Contract (now internal)
- `Storage.Contract/IStorage.cs` - Updated to accept Document
- `Storage.File/Storage.cs` - Simplified, removed StorageDocument
- `doc/ContextHierarchy.md` - New architectural documentation
- All test files updated to use Document

## Metrics
- **Tests passing:** 21/21 unit tests ✅
- **Architecture violations:** 0 circular dependencies ✅
- **Code removed:** IDocument interface, StorageDocument class, TestDocument helpers
- **Complexity reduced:** Cleaner, simpler design with less abstraction
